# nwtgck/actions-netlify@4cbaf4c08f1a7bfa537d6113472ef4424e4eb654

name: Monorepo CI/CD

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'

jobs:
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true
      - name: Setup Node & Install (composite)
        uses: ./.github/actions/setup-node
        with:
          node-version: '22'
          cache-dependency-path: '**/package-lock.json'

      - name: Lint
        run: npm run lint

      - name: Format Check
        run: npm run format:check

  typecheck:
    runs-on: ubuntu-latest
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      VITE_ADMIN_EMAIL: ${{ secrets.VITE_ADMIN_EMAIL }}
      VITE_ADMIN_PASSWORD: ${{ secrets.VITE_ADMIN_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true
      - name: Setup Node & Install (composite)
        uses: ./.github/actions/setup-node
        with:
          node-version: '22'
          cache-dependency-path: '**/package-lock.json'

      - name: Restore turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/package-lock.json','**/package.json','apps/**/src/**','packages/**/src/**') }}

      - name: Build packages (shared & ui)
        run: |
          npm --workspace @jpx/shared run build
          npm --workspace @jpx/ui run build

      - name: Typecheck
        run: npm run typecheck

  unit-tests:
    runs-on: ubuntu-latest
    needs: [lint-format, typecheck]
    strategy:
      matrix:
        package: [frontend, admin-panel, '@jpx/ui', '@jpx/shared']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: Setup Node & Install (composite)
        uses: ./.github/actions/setup-node
        with:
          node-version: '22'
          cache-dependency-path: '**/package-lock.json'

      - name: Restore turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/package-lock.json','**/package.json','apps/**/src/**','packages/**/src/**') }}

      - name: Run unit tests for workspace
        run: |
          echo "Running unit tests for ${{ matrix.package }}"
          npm --workspace "${{ matrix.package }}" run test:unit
        shell: bash

  e2e-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        workspace: [frontend, admin-panel]
        shard: [0, 1]
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      VITE_ADMIN_EMAIL: ${{ secrets.VITE_ADMIN_EMAIL }}
      VITE_ADMIN_PASSWORD: ${{ secrets.VITE_ADMIN_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true
      - name: Setup Node & Install (composite)
        uses: ./.github/actions/setup-node
        with:
          node-version: '22'
          cache-dependency-path: '**/package-lock.json'

      - name: Run E2E specs for workspace shard
        env:
          WORKSPACE: ${{ matrix.workspace }}
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_COUNT: 2
        run: |
          set -euo pipefail
          spec_dir="apps/${WORKSPACE}/cypress/e2e"
          if [ ! -d "$spec_dir" ]; then
            echo "No e2e specs directory for $WORKSPACE: $spec_dir"
            exit 0
          fi
          mapfile -t all_specs < <(ls "$spec_dir"/*.cy.* 2>/dev/null || true)
          total=${#all_specs[@]}
          if [ "$total" -eq 0 ]; then
            echo "No specs found for $WORKSPACE"
            exit 0
          fi
          chunk_size=$(( (total + SHARD_COUNT - 1) / SHARD_COUNT ))
          start=$(( SHARD_INDEX * chunk_size ))
          selected=( "${all_specs[@]:start:chunk_size}" )
          if [ ${#selected[@]} -eq 0 ]; then
            echo "No specs for this shard (index $SHARD_INDEX)"
            exit 0
          fi
          spec_arg="$(IFS=,; echo "${selected[*]}")"
          echo "Starting build+preview for $WORKSPACE"
          if [ "$WORKSPACE" = "frontend" ]; then
            PORT=5173
          else
            PORT=5174
          fi
          BASE_URL="http://localhost:${PORT}"
          # Ensure shared packages are built so TypeScript references resolve
          npm --workspace @jpx/shared run build || true
          npm --workspace @jpx/ui run build || true
          npm --workspace "${WORKSPACE}" run build
          # start preview on desired port in background
          npm --workspace "${WORKSPACE}" run preview -- --port ${PORT} > /tmp/${WORKSPACE}-preview.log 2>&1 &
          preview_pid=$!
          echo "Waiting for ${BASE_URL} to be available"
          npx wait-on ${BASE_URL} --timeout 300000
          echo "Running cypress for $WORKSPACE shard $SHARD_INDEX/$SHARD_COUNT specs: $spec_arg"
          npx cypress run --config-file "apps/${WORKSPACE}/cypress.config.ts" --config supportFile=false,baseUrl=${BASE_URL} --spec "$spec_arg"
          kill ${preview_pid} || true
        shell: bash

  # ===========================
  # Build + Deploy (main only)
  # ===========================
  build-deploy:
    needs: unit-tests
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: Setup Node.js (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Restore turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/package-lock.json','**/package.json','apps/**/src/**','packages/**/src/**') }}

      - name: Build shared
        run: npm --workspace @jpx/shared run build

      - name: Build ui
        run: npm --workspace @jpx/ui run build

      - name: Build frontend
        run: |
          npm --workspace frontend run build
          cp apps/frontend/netlify.toml apps/frontend/dist/netlify.toml
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Build admin panel
        run: |
          npm --workspace admin-panel run build
          cp apps/admin-panel/netlify.toml apps/admin-panel/dist/netlify.toml
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deploy Frontend
        uses: nwtgck/actions-netlify@4cbaf4c08f1a7bfa537d6113472ef4424e4eb654
        with:
          publish-dir: apps/frontend/dist
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deploy Admin Panel
        uses: nwtgck/actions-netlify@4cbaf4c08f1a7bfa537d6113472ef4424e4eb654
        with:
          publish-dir: apps/admin-panel/dist
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.ADMIN_NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.ADMIN_NETLIFY_SITE_ID }}
